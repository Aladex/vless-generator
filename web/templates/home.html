<!DOCTYPE html>
<html lang="{{.Language}}">
<head>
    <title>{{.Title}}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- QR Code generation is now handled on the backend -->
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>{{.Texts.title}}</h1>
            <div class="header-controls">
                <div class="language-selector">
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="en" {{if eq .Language "en"}}selected{{end}}>English</option>
                        <option value="ru" {{if eq .Language "ru"}}selected{{end}}>–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-line">
                <div class="progress-line-fill" id="progressFill"></div>
            </div>
            <div class="progress-step">
                <div class="step-circle current" id="step1Circle">1</div>
                <div class="step-label active">{{.Texts.basic_config}}</div>
            </div>
            <div class="progress-step">
                <div class="step-circle pending" id="step2Circle">2</div>
                <div class="step-label">{{.Texts.network_settings}}</div>
            </div>
            <div class="progress-step">
                <div class="step-circle pending" id="step3Circle">3</div>
                <div class="step-label">{{.Texts.advanced_options}}</div>
            </div>
            <div class="progress-step">
                <div class="step-circle pending" id="step4Circle">4</div>
                <div class="step-label">{{.Texts.generate_share}}</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="wizard-card">
            <!-- Step 1: Basic Configuration -->
            <div class="wizard-step active" id="step1">
                <h2 class="step-title">{{.Texts.basic_configuration}}</h2>

                <div class="form-row narrow-wide">
                    <div class="form-group">
                        <label for="type">{{.Texts.config_type}}</label>
                        <select id="type" name="type" required>
                            <option value="vless">VLESS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="uuid">{{.Texts.uuid_label}}</label>
                        <div class="input-with-button">
                            <input type="text" id="uuid" name="uuid" placeholder="{{.Texts.uuid_placeholder}}" required>
                            <button type="button" class="btn btn-primary btn-small" onclick="generateRandomUUID()">
                                {{.Texts.random_uuid}}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-row wide-narrow">
                    <div class="form-group">
                        <label for="server">{{.Texts.server_label}}</label>
                        <input type="text" id="server" name="server" value="{{.DefaultConfig.Server}}" placeholder="{{.Texts.server_placeholder}}" required>
                    </div>
                    <div class="form-group">
                        <label for="port">{{.Texts.server_port}}</label>
                        <input type="number" id="port" name="port" value="{{.DefaultConfig.ServerPort}}" placeholder="443" required>
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="nav-left"></div>
                    <div class="nav-right">
                        <button class="btn btn-primary" onclick="nextStep()">{{.Texts.next}}</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Network Settings -->
            <div class="wizard-step" id="step2">
                <h2 class="step-title">{{.Texts.network_configuration}}</h2>

                <div class="form-group">
                    <label for="ws-path">{{.Texts.ws_path}}</label>
                    <input type="text" id="ws-path" name="ws-path" value="{{.DefaultConfig.WSPath}}" placeholder="/websocket">
                </div>

                <div class="form-row narrow-wide">
                    <div class="form-group">
                        <label for="dns-server">{{.Texts.dns_server}}</label>
                        <input type="text" id="dns-server" name="dns-server" value="{{.DefaultConfig.DNSServer}}" placeholder="8.8.8.8">
                    </div>
                    <div class="form-group">
                        <label for="doh-server">{{.Texts.doh_server}}</label>
                        <input type="text" id="doh-server" name="doh-server" value="{{.DefaultConfig.DOHServer}}" placeholder="https://223.5.5.5/dns-query">
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="nav-left">
                        <button class="btn btn-primary" onclick="prevStep()">{{.Texts.previous}}</button>
                    </div>
                    <div class="nav-right">
                        <button class="btn btn-primary" onclick="nextStep()">{{.Texts.next}}</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Advanced Options -->
            <div class="wizard-step" id="step3">
                <h2 class="step-title">{{.Texts.advanced_configuration}}</h2>

                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>{{.Texts.tun_settings}}</span>
                        <span class="chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-row wide-narrow">
                            <div class="form-group">
                                <label for="tun-address">{{.Texts.tun_address}}</label>
                                <input type="text" id="tun-address" name="tun-address" value="{{.DefaultConfig.TunAddress}}" placeholder="172.19.0.1/28">
                            </div>
                            <div class="form-group">
                                <label for="tun-mtu">{{.Texts.tun_mtu}}</label>
                                <input type="number" id="tun-mtu" name="tun-mtu" value="{{.DefaultConfig.TunMTU}}" placeholder="9000">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>{{.Texts.port_settings}}</span>
                        <span class="chevron">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label for="mixed-port">{{.Texts.mixed_port}}</label>
                            <input type="number" id="mixed-port" name="mixed-port" value="{{.DefaultConfig.MixedPort}}" placeholder="2080">
                        </div>
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="nav-left">
                        <button class="btn btn-primary" onclick="prevStep()">{{.Texts.previous}}</button>
                    </div>
                    <div class="nav-right">
                        <button class="btn btn-primary" onclick="nextStep()">{{.Texts.next}}</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Generate & Share -->
            <div class="wizard-step" id="step4">
                <h2 class="step-title">{{.Texts.your_configuration}}</h2>

                <div class="result-section">
                    <p>{{.Texts.config_ready_desc}}</p>

                    <div class="generated-link" id="generatedLink"></div>

                    <div class="qr-code-container" id="qrCodeContainer">
                        <div class="qr-placeholder">
                            <div>üì±</div>
                            <div>QR Code will appear here</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-success btn-large" onclick="copyToClipboard()">
                            {{.Texts.copy_configuration}}
                        </button>
                        <a id="openLink" href="#" target="_blank" class="btn btn-primary btn-large">
                            {{.Texts.open_configuration}}
                        </a>
                        <button class="btn btn-warning btn-large" onclick="startOver()">
                            {{.Texts.start_over}}
                        </button>
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="nav-left">
                        <button class="btn btn-primary" onclick="prevStep()">{{.Texts.previous}}</button>
                    </div>
                    <div class="nav-right"></div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>{{.Texts.instructions_title}}</h3>
            <p>{{.Texts.instruction1}}</p>
            <p>{{.Texts.instruction2}}</p>
            <p>{{.Texts.instruction3}}</p>
            <p>{{.Texts.instruction4}}</p>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Initialize wizard
        window.addEventListener('load', function() {
            generateRandomUUID();
            updateProgress();
        });

        // Step Navigation
        function nextStep() {
            if (currentStep < totalSteps) {
                if (validateCurrentStep()) {
                    if (currentStep === 3) {
                        generateConfig();
                    }
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgress();
            }
        }

        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach((el, index) => {
                el.classList.remove('active');
                if (index + 1 === step) {
                    el.classList.add('active', 'fade-in');
                }
            });
        }

        function updateProgress() {
            const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressFill').style.width = progressPercentage + '%';

            // Update step circles
            for (let i = 1; i <= totalSteps; i++) {
                const circle = document.getElementById(`step${i}Circle`);
                const label = circle.nextElementSibling;

                if (i < currentStep) {
                    circle.className = 'step-circle completed';
                    circle.innerHTML = '‚úì';
                    label.classList.remove('active');
                } else if (i === currentStep) {
                    circle.className = 'step-circle current';
                    circle.innerHTML = i;
                    label.classList.add('active');
                } else {
                    circle.className = 'step-circle pending';
                    circle.innerHTML = i;
                    label.classList.remove('active');
                }
            }
        }

        function validateCurrentStep() {
            const requiredFields = [];

            if (currentStep === 1) {
                requiredFields.push('uuid', 'server', 'port');
            }

            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    field.style.borderColor = '#EF4444';
                    setTimeout(() => {
                        field.style.borderColor = '';
                    }, 3000);
                    return false;
                }
            }
            return true;
        }

        // UUID Generation
        function generateRandomUUID() {
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            document.getElementById('uuid').value = uuid;
        }

        // Collapsible Sections
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const chevron = header.querySelector('.chevron');

            if (content.classList.contains('open')) {
                content.classList.remove('open');
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('open');
                chevron.classList.add('rotated');
            }
        }

        // Config Generation
        function generateConfig() {
            const formData = collectFormData();
            const type = formData.type;
            const uuid = formData.uuid;

            // Build query parameters for page URL
            const params = new URLSearchParams();
            params.append('lang', '{{.Language}}');

            // Add all form fields as query parameters (except type and uuid)
            for (let [key, value] of Object.entries(formData)) {
                if (key !== 'type' && value.trim() !== '') {
                    params.append(key, value.trim());
                }
            }

            // Build the page URL
            const baseUrl = window.location.origin;
            const configUrl = baseUrl + '/' + type + '/' + uuid;
            const pageUrl = params.toString() ? configUrl + '?' + params.toString() : configUrl;

            // Generate VLESS URL for QR code
            const server = formData.server || 'example.com';
            const port = formData.port || '443';
            const wsPath = formData['ws-path'] || '/websocket';

            // Encode WebSocket path for URL
            const encodedPath = encodeURIComponent(wsPath);

            // Build VLESS URL
            const vlessUrl = `vless://${uuid}@${server}:${port}?type=ws&security=tls&path=${encodedPath}&host=${server}#VLESS-Config`;

            // Display result
            document.getElementById('generatedLink').textContent = pageUrl;
            document.getElementById('openLink').href = pageUrl;

            // Generate QR Code with VLESS URL
            generateQRCode(vlessUrl);
        }

        function collectFormData() {
            const fields = [
                'type', 'uuid', 'server', 'port', 'ws-path',
                'dns-server', 'doh-server', 'tun-address', 'tun-mtu', 'mixed-port'
            ];

            const data = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value || '';
                }
            });

            return data;
        }

        function generateQRCode(url) {
            const container = document.getElementById('qrCodeContainer');

            // Show loading state
            container.innerHTML = '<div class="qr-placeholder"><div>‚è≥</div><div>Generating QR Code...</div></div>';

            // Create form data for POST request
            const formData = new FormData();
            formData.append('url', url);

            // Send request to backend QR code endpoint
            fetch('/qrcode', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate QR code');
                }
                return response.blob();
            })
            .then(blob => {
                // Create image element
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                img.alt = 'VLESS Configuration QR Code';
                img.style.maxWidth = '200px';
                img.style.height = 'auto';
                img.style.border = '1px solid #E5E7EB';
                img.style.borderRadius = '8px';

                // Replace loading state with QR code
                container.innerHTML = '';
                container.appendChild(img);
            })
            .catch(error => {
                console.error('QR Code generation failed:', error);
                container.innerHTML = '<div class="qr-placeholder"><div>‚ùå</div><div>QR Code generation failed</div></div>';
            });
        }

        // Utility Functions
        function copyToClipboard() {
            const link = document.getElementById('generatedLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '{{.Texts.copied}}';
                button.classList.add('success-animation');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('success-animation');
                }, 2000);
            });
        }

        function startOver() {
            currentStep = 1;
            showStep(1);
            updateProgress();
            generateRandomUUID();

            // Clear non-default form values
            document.querySelectorAll('input:not([value])').forEach(input => {
                if (input.id !== 'uuid') {
                    input.value = '';
                }
            });
        }

        function changeLanguage() {
            const language = document.getElementById('languageSelect').value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('lang', language);
            window.location.href = currentUrl.toString();
        }

        // Auto-save progress (visual feedback)
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', function() {
                // Add a subtle save indicator
                this.style.borderColor = 'var(--success-color)';
                setTimeout(() => {
                    this.style.borderColor = '';
                }, 1000);
            });
        });
    </script>
</body>
</html>
